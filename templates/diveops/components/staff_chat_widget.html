{% load static %}
{# Staff Chat Widget - Facebook-style floating chat for staff portal #}

<div id="staff-chat-widget" x-data="staffChatWidget()" x-cloak>
    <!-- Chat Bubble Button -->
    <button @click="togglePanel()"
            class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all z-50"
            :class="{ 'ring-4 ring-blue-300': hasUnread }">
        <!-- Chat icon -->
        <svg x-show="!panelOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <!-- Close icon -->
        <svg x-show="panelOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        <!-- Unread badge -->
        <span x-show="unreadCount > 0"
              class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center"
              x-text="unreadCount > 9 ? '9+' : unreadCount"></span>
    </button>

    <!-- Conversations Panel -->
    <div x-show="panelOpen && !activeConversation"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         class="fixed bottom-24 right-6 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden z-50">
        <!-- Header -->
        <div class="bg-blue-600 text-white px-4 py-3">
            <h3 class="font-semibold">Lead Conversations</h3>
            <p class="text-xs text-blue-100" x-text="conversations.length + ' active chats'"></p>
        </div>

        <!-- Search -->
        <div class="p-2 border-b">
            <input type="text"
                   x-model="searchQuery"
                   placeholder="Search leads..."
                   class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Conversations List -->
        <div class="max-h-96 overflow-y-auto">
            <template x-if="loading">
                <div class="p-4 text-center text-gray-500">
                    <svg class="animate-spin h-6 w-6 mx-auto text-blue-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-sm">Loading conversations...</p>
                </div>
            </template>

            <template x-if="!loading && filteredConversations.length === 0">
                <div class="p-4 text-center text-gray-500">
                    <p class="text-sm">No conversations yet</p>
                </div>
            </template>

            <template x-for="conv in filteredConversations" :key="conv.person_id">
                <button @click="openConversation(conv)"
                        class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 border-b border-gray-100 text-left transition-colors"
                        :class="{ 'bg-blue-50': conv.needs_reply }">
                    <!-- Avatar -->
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm"
                         :class="conv.needs_reply ? 'bg-red-500' : 'bg-gray-400'"
                         x-text="conv.initials"></div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-gray-900 truncate" x-text="conv.name"></span>
                            <span class="text-xs text-gray-500" x-text="conv.last_message_time"></span>
                        </div>
                        <p class="text-sm text-gray-500 truncate" x-text="conv.last_message"></p>
                    </div>

                    <!-- Unread indicator -->
                    <div x-show="conv.needs_reply" class="w-2 h-2 bg-red-500 rounded-full"></div>
                </button>
            </template>
        </div>
    </div>

    <!-- Active Chat Window -->
    <div x-show="panelOpen && activeConversation"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         class="fixed bottom-24 right-6 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden z-50">
        <!-- Chat Header -->
        <div class="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button @click="closeConversation()" class="hover:bg-blue-700 p-1 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div>
                    <h3 class="font-semibold" x-text="activeConversation?.name"></h3>
                    <p class="text-xs text-blue-100" x-text="activeConversation?.email"></p>
                </div>
            </div>
            <a :href="'/staff/leads/' + activeConversation?.person_id + '/'"
               class="text-xs bg-blue-700 hover:bg-blue-800 px-2 py-1 rounded">
                View Lead
            </a>
        </div>

        <!-- Messages -->
        <div id="chat-messages-container" class="h-80 overflow-y-auto p-4 space-y-3 bg-gray-50">
            <template x-for="msg in messages" :key="msg.id">
                <div :class="msg.direction === 'outbound' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.direction === 'outbound'
                                 ? 'bg-blue-600 text-white rounded-lg rounded-br-sm'
                                 : 'bg-white border border-gray-200 text-gray-800 rounded-lg rounded-bl-sm'"
                         class="max-w-[80%] px-3 py-2 shadow-sm">
                        <p class="text-sm whitespace-pre-wrap" x-text="msg.body"></p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-xs opacity-70" x-text="msg.time"></span>
                            <!-- Status indicators for outbound messages -->
                            <span x-show="msg.direction === 'outbound'" class="ml-2">
                                <!-- Sending/Queued: single gray check -->
                                <svg x-show="msg.status === 'queued' || msg.status === 'sending'" class="w-4 h-4 inline opacity-50" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                <!-- Sent: single check -->
                                <svg x-show="msg.status === 'sent'" class="w-4 h-4 inline opacity-70" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                <!-- Delivered: double check -->
                                <span x-show="msg.status === 'delivered'" class="inline-flex">
                                    <svg class="w-4 h-4 -mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </span>
                                <!-- Read: double blue check -->
                                <span x-show="msg.status === 'read'" class="inline-flex text-blue-300">
                                    <svg class="w-4 h-4 -mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </span>
                                <!-- Failed: red X -->
                                <svg x-show="msg.status === 'failed'" class="w-4 h-4 inline text-red-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
            </template>

            <template x-if="messages.length === 0 && !loadingMessages">
                <div class="text-center text-gray-500 py-8">
                    <p class="text-sm">No messages yet</p>
                </div>
            </template>
        </div>

        <!-- Input -->
        <div class="p-3 border-t bg-white">
            <form @submit.prevent="sendMessage()" class="flex gap-2">
                <input type="text"
                       x-model="newMessage"
                       placeholder="Type a message..."
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                       :disabled="sending">
                <button type="submit"
                        :disabled="!newMessage.trim() || sending"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <svg x-show="!sending" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    <svg x-show="sending" class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function staffChatWidget() {
    return {
        panelOpen: false,
        loading: true,
        conversations: [],
        searchQuery: '',
        activeConversation: null,
        messages: [],
        loadingMessages: false,
        newMessage: '',
        sending: false,
        ws: null,
        unreadCount: 0,
        hasUnread: false,

        init() {
            this.loadConversations();
            // Refresh conversations every 30 seconds
            setInterval(() => {
                if (!this.activeConversation) {
                    this.loadConversations();
                }
            }, 30000);
        },

        get filteredConversations() {
            if (!this.searchQuery) return this.conversations;
            const q = this.searchQuery.toLowerCase();
            return this.conversations.filter(c =>
                c.name.toLowerCase().includes(q) ||
                c.email.toLowerCase().includes(q)
            );
        },

        togglePanel() {
            this.panelOpen = !this.panelOpen;
            if (this.panelOpen && this.conversations.length === 0) {
                this.loadConversations();
            }
        },

        async loadConversations() {
            this.loading = true;
            try {
                const resp = await fetch('/staff/api/chat/conversations/');
                const data = await resp.json();
                this.conversations = data.conversations || [];
                this.unreadCount = this.conversations.filter(c => c.needs_reply).length;
                this.hasUnread = this.unreadCount > 0;
            } catch (err) {
                console.error('Failed to load conversations:', err);
            } finally {
                this.loading = false;
            }
        },

        async openConversation(conv) {
            this.activeConversation = conv;
            this.loadingMessages = true;
            this.messages = [];

            try {
                const resp = await fetch(`/staff/api/chat/conversations/${conv.person_id}/messages/`);
                const data = await resp.json();
                this.messages = data.messages || [];
                this.$nextTick(() => this.scrollToBottom());

                // Mark inbound messages as read
                this.markMessagesRead(conv.person_id);
            } catch (err) {
                console.error('Failed to load messages:', err);
            } finally {
                this.loadingMessages = false;
            }

            // Connect WebSocket for real-time updates
            this.connectWebSocket(conv.person_id);
        },

        async markMessagesRead(personId) {
            try {
                await fetch(`/staff/api/chat/conversations/${personId}/mark-read/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
            } catch (err) {
                console.error('Failed to mark messages as read:', err);
            }
        },

        closeConversation() {
            this.activeConversation = null;
            this.messages = [];
            this.disconnectWebSocket();
            this.loadConversations(); // Refresh list
        },

        connectWebSocket(personId) {
            this.disconnectWebSocket();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/lead/${personId}/`;

            this.ws = new WebSocket(wsUrl);

            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Staff WebSocket message:', data);
                if (data.type === 'connection_established') {
                    console.log('Staff WebSocket room joined:', data.room);
                } else if (data.type === 'new_message') {
                    this.messages.push({
                        id: data.message_id,
                        body: data.body || data.message,
                        direction: data.direction || (data.sender_person_id ? 'inbound' : 'outbound'),
                        status: data.status || 'sent',
                        time: this.formatTime(data.created_at)
                    });
                    this.$nextTick(() => this.scrollToBottom());

                    // If inbound message, mark as read since staff is viewing
                    if (data.direction === 'inbound' && this.activeConversation) {
                        this.markMessagesRead(this.activeConversation.person_id);
                    }
                } else if (data.type === 'message_status_update') {
                    // Update status of existing message
                    const msg = this.messages.find(m => m.id === data.message_id);
                    if (msg) {
                        msg.status = data.status;
                    }
                }
            };

            this.ws.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        },

        disconnectWebSocket() {
            if (this.ws) {
                this.ws.close();
                this.ws = null;
            }
        },

        async sendMessage() {
            if (!this.newMessage.trim() || this.sending) return;

            this.sending = true;
            const messageText = this.newMessage;
            this.newMessage = '';

            try {
                const resp = await fetch(`/staff/leads/${this.activeConversation.person_id}/send-message/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: new URLSearchParams({ message: messageText })
                });

                if (resp.redirected || resp.ok) {
                    // Message sent successfully - it will appear via WebSocket
                    // or we add it optimistically
                    this.messages.push({
                        id: 'temp-' + Date.now(),
                        body: messageText,
                        direction: 'outbound',
                        status: 'sending',
                        time: 'Just now'
                    });
                    this.$nextTick(() => this.scrollToBottom());
                } else {
                    throw new Error('Failed to send');
                }
            } catch (err) {
                console.error('Failed to send message:', err);
                this.newMessage = messageText; // Restore message
                alert('Failed to send message. Please try again.');
            } finally {
                this.sending = false;
            }
        },

        scrollToBottom() {
            const container = document.getElementById('chat-messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        },

        getCsrfToken() {
            const cookie = document.cookie.split('; ').find(c => c.startsWith('csrftoken='));
            return cookie ? cookie.split('=')[1] : '';
        }
    }
}
</script>
